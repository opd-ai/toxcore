# Audit: github.com/opd-ai/toxcore/file
**Date**: 2026-02-19
**Status**: Complete

## Summary
The file package implements Tox protocol file transfer functionality with secure chunked transmission, state management, and transport integration. Overall code quality is strong with 81.6% test coverage and clean separation between Transfer (individual file I/O) and Manager (network coordination). Security protections include directory traversal validation, chunk size limits, and stall timeout detection. No critical issues found.

## Issues Found
- [ ] low API Design — `Transfer` struct has exported fields (FriendID, FileID, State, etc.) that could be accessed without synchronization, violating mutex protection (`transfer.go:100-123`)
- [ ] low Error Handling — Close errors in `Cancel` are logged but not wrapped in returned error, potentially losing context (`transfer.go:376-384`)
- [ ] low Concurrency Safety — `completeCallback` accessed without lock protection before mutex acquisition in `Cancel` (`transfer.go:389-391`)
- [ ] low Documentation — `doc.go` duplicates package doc comment from `transfer.go` unnecessarily (`doc.go:1-13`, `transfer.go:1-13`)
- [ ] med API Design — `Manager.SendFile` requires caller to provide `fileID`, which should be auto-generated by Manager to prevent collisions (`manager.go:118`)
- [ ] low Dependencies — Direct use of concrete `*transport.Packet` type instead of interface reduces testability (`manager.go:151-154`)
- [ ] low Determinism — `DefaultTimeProvider` uses `time.Now()` directly, but TimeProvider abstraction is properly implemented for testing (`transfer.go:92`)
- [ ] low Documentation — `Manager.SendChunk` lacks godoc comment and export annotation (`manager.go:185`)

## Test Coverage
81.6% (target: 65%) — ✓ Exceeds target

**Coverage breakdown by file**:
- `transfer.go`: Well covered with state transitions, timeout handling, and I/O operations
- `manager.go`: Good coverage for packet handling and transfer coordination
- Test files include benchmarks, state machine tests, timeout tests, and mock transport

## Dependencies
**Internal**:
- `github.com/opd-ai/toxcore/transport` — Network packet transport abstraction

**External**:
- `github.com/sirupsen/logrus` — Structured logging
- Standard library: `encoding/binary`, `errors`, `fmt`, `io`, `net`, `os`, `path/filepath`, `strings`, `sync`, `time`

**Integration Points**:
- Transport layer via packet handlers (FileRequest, FileControl, FileData, FileDataAck)
- Address resolution interface for friend ID mapping
- TimeProvider interface for deterministic time handling in tests

## Recommendations
1. Make Transfer fields unexported and add getter methods to prevent unsynchronized access
2. Auto-generate fileID in Manager.SendFile to prevent caller errors and ID collisions
3. Add godoc comments to all exported Manager methods (SendChunk missing)
4. Consider refactoring Manager to use transport interface methods instead of concrete Packet type
5. Remove duplicate package doc in doc.go (already comprehensive in transfer.go)
